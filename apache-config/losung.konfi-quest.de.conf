# Apache VirtualHost für losung.konfi-quest.de
# BibleScraper Pro - Complete Bible Text Search Platform

<VirtualHost *:80>
    ServerName losung.konfi-quest.de
    
    # Redirect zu HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
</VirtualHost>

<VirtualHost *:443>
    ServerName losung.konfi-quest.de
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/losung.konfi-quest.de/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/losung.konfi-quest.de/privkey.pem
    
    # Security Headers
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # CORS für API-Zugriffe
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET,POST,PUT,DELETE,OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type,Authorization,X-API-Key"
    
    # Let's Encrypt Challenge
    ProxyPass /.well-known/ !
    Alias /.well-known/ /var/www/html/.well-known/
    
    # API Endpunkte (Backend)
    # Alle API-Calls gehen an den Backend-Container
    ProxyPass /api/ http://127.0.0.1:8374/
    ProxyPassReverse /api/ http://127.0.0.1:8374/
    
    # Legacy API Support (direkte Calls ohne /api/ prefix)
    ProxyPass /bible_search.php http://127.0.0.1:8374/bible_search.php
    ProxyPassReverse /bible_search.php http://127.0.0.1:8374/bible_search.php
    
    # Root-API für Tageslosung
    ProxyPass /index.php http://127.0.0.1:8374/index.php
    ProxyPassReverse /index.php http://127.0.0.1:8374/index.php
    
    # Rewrite für API calls mit api_key Parameter
    RewriteEngine On
    RewriteCond %{QUERY_STRING} api_key=
    RewriteRule ^/?$ http://127.0.0.1:8374/index.php [P,L]
    
    # Alle anderen Requests gehen an das React Frontend
    ProxyPass / http://127.0.0.1:3030/
    ProxyPassReverse / http://127.0.0.1:3030/
    
    # Proxy Settings für bessere Performance
    ProxyPreserveHost On
    ProxyTimeout 300
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/losung.konfi-quest.de_error.log
    CustomLog ${APACHE_LOG_DIR}/losung.konfi-quest.de_access.log combined
    
    # Compression
    <Location />
        SetOutputFilter DEFLATE
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png|ico|woff|woff2|ttf|eot)$ no-gzip dont-vary
        SetEnvIfNoCase Request_URI \
            \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
    </Location>
</VirtualHost>

# Alternative Konfiguration wenn API und Frontend getrennt gehostet werden sollen:
#
# API unter api.losung.konfi-quest.de:
# <VirtualHost *:443>
#     ServerName api.losung.konfi-quest.de
#     ProxyPass / http://127.0.0.1:8374/
#     ProxyPassReverse / http://127.0.0.1:8374/
# </VirtualHost>
#
# Frontend unter losung.konfi-quest.de:
# <VirtualHost *:443>
#     ServerName losung.konfi-quest.de
#     ProxyPass / http://127.0.0.1:3847/
#     ProxyPassReverse / http://127.0.0.1:3847/
# </VirtualHost>